# راهنمای استقرار روی Hamravesh

## مرحله ۱: آماده‌سازی اولیه

### ۱.۱ اجرای اسکریپت تنظیمات
```bash
./setup-hamravesh.sh
```

### ۱.۲ دریافت اطلاعات از پنل Hamravesh
1. وارد پنل Hamravesh شوید
2. به بخش Container Registry بروید
3. Token مربوط به registry را کپی کنید
4. به بخش Kubernetes بروید
5. کانفیگ cluster را دانلود کنید

## مرحله ۲: تنظیم محیط

### ۲.۱ تنظیم متغیرهای محیطی
```bash
# نام کاربری Hamravesh
export HAMRAVESH_USERNAME="نام-کاربری-شما"

# Token مربوط به registry
export HAMRAVESH_TOKEN="token-شما"

# مسیر کانفیگ Kubernetes
export KUBECONFIG="path/to/your/kubeconfig"
```

### ۲.۲ تست اتصال
```bash
# تست Docker
docker --version

# تست kubectl
kubectl cluster-info

# تست اتصال به registry
docker login registry.hamravesh.com
```

## مرحله ۳: ساخت و ارسال Image

### ۳.۱ ساخت Image
```bash
# ساخت image با اسکریپت آماده
./scripts/build-and-push.sh v1.0.0

# یا به صورت دستی
docker build -t registry.hamravesh.com/نام-کاربری/نام-پروژه:latest .
```

### ۳.۲ ارسال به Registry
```bash
# ورود به registry
docker login registry.hamravesh.com

# ارسال image
docker push registry.hamravesh.com/نام-کاربری/نام-پروژه:latest
```

## مرحله ۴: استقرار روی Kubernetes

### ۴.۱ استقرار با اسکریپت
```bash
# استقرار در namespace پیش‌فرض
./scripts/deploy.sh

# استقرار در namespace خاص
./scripts/deploy.sh nlp-production
```

### ۴.۲ استقرار دستی
```bash
# اعمال تمام manifest ها
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
kubectl apply -f k8s/ingress.yaml

# بررسی وضعیت
kubectl rollout status deployment/nlp-toolkit
```

## مرحله ۵: تنظیم دسترسی عمومی

### ۵.۱ تنظیم Domain
1. فایل `k8s/ingress.yaml` را ویرایش کنید
2. `your-domain.com` را با domain خود جایگزین کنید
3. ingress را اعمال کنید:
```bash
kubectl apply -f k8s/ingress.yaml
```

### ۵.۲ تنظیم DNS
1. IP خارجی cluster را دریافت کنید:
```bash
kubectl get ingress nlp-toolkit-ingress
```
2. Domain خود را به این IP اشاره دهید

## مرحله ۶: بررسی و تست

### ۶.۱ بررسی وضعیت
```bash
# بررسی pods
kubectl get pods -l app=nlp-toolkit

# بررسی services
kubectl get services

# بررسی ingress
kubectl get ingress

# مشاهده logs
kubectl logs -f deployment/nlp-toolkit
```

### ۶.۲ تست API
```bash
# تست health check
curl https://your-domain.com/health

# تست API endpoints
curl -X POST https://your-domain.com/api/regex \
  -H "Content-Type: application/json" \
  -d '{"mode": "dates", "text": "تاریخ امروز ۱۴۰۳/۰۱/۰۱ است"}'
```

## عیب‌یابی

### مشکلات رایج

#### ۱. خطای Image Pull
```bash
# بررسی credentials
docker login registry.hamravesh.com

# بررسی وجود image
docker pull registry.hamravesh.com/نام-کاربری/نام-پروژه:latest
```

#### ۲. خطای Pod Startup
```bash
# بررسی logs
kubectl logs deployment/nlp-toolkit

# بررسی events
kubectl get events --sort-by=.metadata.creationTimestamp

# بررسی منابع
kubectl describe pod <pod-name>
```

#### ۳. خطای Ingress
```bash
# بررسی ingress controller
kubectl get pods -n ingress-nginx

# بررسی DNS
nslookup your-domain.com

# بررسی SSL certificate
kubectl describe certificate nlp-toolkit-tls
```

## دستورات مفید

```bash
# اجرای دستور در pod
kubectl exec -it <pod-name> -- /bin/bash

# port forward برای تست محلی
kubectl port-forward service/nlp-toolkit-service 8080:80

# scale کردن
kubectl scale deployment nlp-toolkit --replicas=3

# به‌روزرسانی image
kubectl set image deployment/nlp-toolkit nlp-toolkit=registry.hamravesh.com/نام-کاربری/نام-پروژه:v1.1.0

# rollback
kubectl rollout undo deployment/nlp-toolkit
```

## نکات مهم

1. **امنیت**: تمام secrets را در Kubernetes secrets ذخیره کنید
2. **مانیتورینگ**: از kubectl logs برای بررسی وضعیت استفاده کنید
3. **بک‌آپ**: تنظیمات مهم را backup کنید
4. **آپدیت**: برای آپدیت، image جدید بسازید و deployment را به‌روزرسانی کنید

## پشتیبانی

برای مشکلات مربوط به Hamravesh:
- مستندات Hamravesh را مطالعه کنید
- با پشتیبانی Hamravesh تماس بگیرید

برای مشکلات مربوط به اپلیکیشن:
- logs را بررسی کنید
- تنظیمات را چک کنید
- محلی با Docker تست کنید
